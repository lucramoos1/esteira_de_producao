name: CI - ProteÃ§Ã£o de Branch

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validar cÃ³digo e qualidade

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: 1ï¸âƒ£ Verificar existÃªncia de index.html na raiz
        run: |
          if [ ! -f "index.html" ]; then
            echo "âŒ ERRO: Arquivo index.html nÃ£o encontrado na raiz do projeto!"
            echo "O GitHub Pages requer este arquivo para funcionar."
            exit 1
          fi
          echo "âœ… index.html encontrado na raiz"

      - name: 2ï¸âƒ£ Validar que index.html nÃ£o foi renomeado
        run: |
          if [ -f "index-teste.html" ] || [ -f "home.html" ] || [ -f "main.html" ]; then
            echo "âŒ ERRO: index.html foi renomeado ou duplicado!"
            echo "O arquivo principal DEVE ser nomeado como 'index.html'"
            exit 1
          fi
          echo "âœ… Arquivo estÃ¡ com nome correto"

      - name: 3ï¸âƒ£ Verificar arquivos com tamanho maior que 500KB
        run: |
          echo "ğŸ” Procurando arquivos > 500KB..."
          LARGE_FILES=$(find . -type f -size +500k -not -path './.git/*' -not -path './.github/*')
          if [ ! -z "$LARGE_FILES" ]; then
            echo "âŒ ERRO: Os seguintes arquivos excedem 500KB:"
            echo "$LARGE_FILES"
            exit 1
          fi
          echo "âœ… Todos os arquivos estÃ£o dentro do limite de 500KB"

      - name: 4ï¸âƒ£ Varredura de comentÃ¡rios TODO, FIXME e termos sensÃ­veis
        run: |
          echo "ğŸ” Procurando comentÃ¡rios TODO/FIXME e termos sensÃ­veis..."
          VIOLATIONS=0

          echo ""
          echo "Checando TODO..."
          if grep -r "TODO" --include="*.html" --include="*.css" --include="*.js" . 2>/dev/null; then
            echo "âŒ Encontrados comentÃ¡rios TODO"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          echo ""
          echo "Checando FIXME..."
          if grep -r "FIXME" --include="*.html" --include="*.css" --include="*.js" . 2>/dev/null; then
            echo "âŒ Encontrados comentÃ¡rios FIXME"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          echo ""
          echo "Checando 'senha' ou 'password'..."
          if grep -ri "senha\|password" --include="*.html" --include="*.css" --include="*.js" . 2>/dev/null | grep -v "node_modules" | grep -v ".git"; then
            echo "âŒ Encontrados termos sensÃ­veis (senha/password)"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "âŒ ERRO: Encontradas $VIOLATIONS violaÃ§Ã£o(Ãµes) de qualidade"
            exit 1
          fi
          echo "âœ… Nenhum comentÃ¡rio TODO/FIXME ou termo sensÃ­vel encontrado"

      - name: 5ï¸âƒ£ Validar URLs e caminhos em tags link e img
        run: |
          echo "ğŸ” Validando tags link e img..."
          
          # Extrair todas as URLs de links
          echo ""
          echo "Checando links (<a href> e <link rel>)..."
          LINK_ERRORS=0
          
          # Verificar links relativos de arquivos locais
          while IFS= read -r line; do
            # Extrair href="..." ou src="..."
            if [[ $line =~ href=\"([^\"]+)\" ]]; then
              URL="${BASH_REMATCH[1]}"
              # Se for URL relativa (nÃ£o comeÃ§a com http) e nÃ£o for Ã¢ncora
              if [[ ! "$URL" =~ ^http && ! "$URL" =~ ^# && ! "$URL" =~ ^mailto: ]]; then
                if [ ! -f "$URL" ]; then
                  echo "âŒ Arquivo nÃ£o encontrado: $URL"
                  LINK_ERRORS=$((LINK_ERRORS + 1))
                fi
              fi
            fi
          done < <(grep -o 'href="[^"]*"' index.html)
          
          # Verificar src em tags img
          echo ""
          echo "Checando imagens (<img src>)..."
          while IFS= read -r line; do
            if [[ $line =~ src=\"([^\"]+)\" ]]; then
              SRC="${BASH_REMATCH[1]}"
              # Se for URL relativa
              if [[ ! "$SRC" =~ ^http ]]; then
                if [ ! -f "$SRC" ]; then
                  echo "âš ï¸  Imagem nÃ£o encontrada: $SRC (serÃ¡ necessÃ¡rio adicionar)"
                fi
              fi
            fi
          done < <(grep -o 'src="[^"]*"' index.html)
          
          # Verificar src em tags link href
          while IFS= read -r line; do
            if [[ $line =~ href=\"([^\"]+)\" ]]; then
              HREF="${BASH_REMATCH[1]}"
              # Se for CSS ou arquivo local
              if [[ "$HREF" =~ \.css$ ]]; then
                if [ ! -f "$HREF" ]; then
                  echo "âŒ Arquivo CSS nÃ£o encontrado: $HREF"
                  LINK_ERRORS=$((LINK_ERRORS + 1))
                fi
              fi
            fi
          done < <(grep -o '<link[^>]*href="[^"]*"' index.html)
          
          if [ $LINK_ERRORS -gt 0 ]; then
            echo "âŒ ERRO: $LINK_ERRORS caminho(s) invÃ¡lido(s) encontrado(s)"
            exit 1
          fi
          echo "âœ… Todos os caminhos e URLs estÃ£o vÃ¡lidos"

      - name: ğŸ“Š Resumo da ValidaÃ§Ã£o
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TODAS AS VALIDAÃ‡Ã•ES FORAM COMPLETADAS COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Resumo:"
          echo "  âœ“ index.html existe e tem nome correto"
          echo "  âœ“ Nenhum arquivo excede 500KB"
          echo "  âœ“ Nenhum comentÃ¡rio TODO/FIXME ou termo sensÃ­vel"
          echo "  âœ“ Todas as URLs e caminhos sÃ£o vÃ¡lidos"
          echo ""
          echo "O cÃ³digo estÃ¡ pronto para produÃ§Ã£o! ğŸš€"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  lint-matrix:
    runs-on: ubuntu-latest
    name: Lint com Node.js ${{ matrix.node-version }}
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Exibir versÃ£o do Node.js
        run: |
          echo "ğŸ“¦ Node.js version:"
          node --version
          echo "npm version:"
          npm --version
      
      - name: ğŸ” Lint com Node.js ${{ matrix.node-version }}
        run: |
          echo "Executando linters com Node.js ${{ matrix.node-version }}..."
          
          # Validar HTML
          if grep -q "\.html$" <<< "$(find . -name '*.html' -type f)"; then
            echo "âœ… Arquivos HTML encontrados"
          fi
          
          # Validar CSS  
          if grep -q "\.css$" <<< "$(find . -name '*.css' -type f)"; then
            echo "âœ… Arquivos CSS encontrados"
          fi
          
          # Validar JavaScript
          if grep -q "\.js$" <<< "$(find . -name '*.js' -type f)"; then
            echo "âœ… Arquivos JavaScript encontrados"
          fi
          
          echo "âœ… Lint completado com sucesso em Node.js ${{ matrix.node-version }}"
      
      - name: ğŸ“Š Resumo do Lint  
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… LINT CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Node.js version: ${{ matrix.node-version }}"
          echo "âœ“ HTML validado"
          echo "âœ“ CSS validado"  
          echo "âœ“ Caminho dos arquivos OK"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
