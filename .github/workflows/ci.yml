name: CI - ProteÃ§Ã£o de Branch

on:
  pull_request:
    branches:
      - main

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validar cÃ³digo e qualidade

    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: 1ï¸âƒ£ Verificar existÃªncia da pasta src/
        run: |
          echo "ğŸ” Verificando pasta src/..."
          if [ ! -d "src" ]; then
            echo "âŒ ERRO: Pasta src/ nÃ£o encontrada na raiz do projeto!"
            exit 1
          fi
          echo "âœ… Pasta src/ encontrada"

      - name: 2ï¸âƒ£ Verificar existÃªncia de index.html em src/
        run: |
          echo "ğŸ” Verificando src/index.html..."
          if [ ! -f "src/index.html" ]; then
            echo "âŒ ERRO: Arquivo src/index.html nÃ£o encontrado!"
            echo "O GitHub Pages requer este arquivo na pasta src/ para funcionar."
            exit 1
          fi
          echo "âœ… src/index.html encontrado"

      - name: 3ï¸âƒ£ Verificar existÃªncia de style.css em src/css/
        run: |
          echo "ğŸ” Verificando src/css/style.css..."
          if [ ! -f "src/css/style.css" ]; then
            echo "âŒ ERRO: Arquivo src/css/style.css nÃ£o encontrado!"
            exit 1
          fi
          echo "âœ… src/css/style.css encontrado"

      - name: 4ï¸âƒ£ Verificar se style.css estÃ¡ referenciado corretamente no HTML
        run: |
          echo "ğŸ” Validando caminho CSS no HTML..."
          if grep -q 'href="css/style.css"' src/index.html; then
            echo "âœ… Caminho CSS estÃ¡ correto no HTML (href=\"css/style.css\")"
          else
            echo "âŒ ERRO: Caminho CSS incorreto no HTML!"
            echo "Esperado: href=\"css/style.css\""
            exit 1
          fi

      - name: 5ï¸âƒ£ Verificar arquivos com tamanho maior que 500KB
        run: |
          echo "ğŸ” Procurando arquivos > 500KB..."
          LARGE_FILES=$(find . -type f -size +500k -not -path './.git/*' -not -path './.github/*')
          if [ ! -z "$LARGE_FILES" ]; then
            echo "âŒ ERRO: Os seguintes arquivos excedem 500KB:"
            echo "$LARGE_FILES"
            exit 1
          fi
          echo "âœ… Todos os arquivos estÃ£o dentro do limite de 500KB"

      - name: 6ï¸âƒ£ Varredura de comentÃ¡rios TODO, FIXME e termos sensÃ­veis
        run: |
          echo "ğŸ” Procurando comentÃ¡rios TODO/FIXME e termos sensÃ­veis..."
          VIOLATIONS=0

          echo ""
          echo "Checando TODO..."
          if grep -rE "\bTODO\b|\bTODO:" --include="*.html" --include="*.css" --include="*.js" src/ 2>/dev/null; then
            echo "âŒ Encontrados comentÃ¡rios TODO"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          echo ""
          echo "Checando FIXME..."
          if grep -rE "\bFIXME\b|\bFIXME:" --include="*.html" --include="*.css" --include="*.js" src/ 2>/dev/null; then
            echo "âŒ Encontrados comentÃ¡rios FIXME"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          echo ""
          echo "Checando 'senha' ou 'password'..."
          if grep -ri "senha\|password" --include="*.html" --include="*.css" --include="*.js" src/ 2>/dev/null; then
            echo "âŒ Encontrados termos sensÃ­veis (senha/password)"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi

          if [ $VIOLATIONS -gt 0 ]; then
            echo ""
            echo "âŒ ERRO: Encontradas $VIOLATIONS violaÃ§Ã£o(Ãµes) de qualidade"
            exit 1
          fi
          echo "âœ… Nenhum comentÃ¡rio TODO/FIXME ou termo sensÃ­vel encontrado"

      - name: 7ï¸âƒ£ Validar existÃªncia de tag footer com nome do aluno
        run: |
          echo "ğŸ” Validando tag footer com nome do aluno..."
          if grep -q "<footer>" src/index.html && grep -iq "lucas araujo" src/index.html; then
            echo "âœ… Footer encontrado com nome do aluno 'Lucas Araujo'"
          else
            echo "âŒ ERRO: Footer nÃ£o contÃ©m o nome do aluno 'Lucas Araujo'!"
            exit 1
          fi

      - name: 8ï¸âƒ£ Setup Node.js para HTMLHint
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: 9ï¸âƒ£ Instalar htmlhint
        run: npm install -g htmlhint

      - name: ğŸ”Ÿ Executar htmlhint em src/index.html
        run: |
          echo "ğŸ” Executando HTMLHint em src/index.html..."
          htmlhint src/index.html
          if [ $? -eq 0 ]; then
            echo "âœ… HTMLHint passou com sucesso"
          else
            echo "âŒ ERRO: HTMLHint encontrou problemas"
            exit 1
          fi

      - name: ğŸ“Š Resumo da ValidaÃ§Ã£o
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… TODAS AS VALIDAÃ‡Ã•ES FORAM COMPLETADAS COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Resumo das VerificaÃ§Ãµes:"
          echo "  âœ“ Pasta src/ existe"
          echo "  âœ“ src/index.html existe"
          echo "  âœ“ src/css/style.css existe"
          echo "  âœ“ Caminhos CSS corretos"
          echo "  âœ“ Nenhum arquivo excede 500KB"
          echo "  âœ“ Nenhum comentÃ¡rio TODO/FIXME ou termo sensÃ­vel"
          echo "  âœ“ Footer contÃ©m o nome do aluno"
          echo "  âœ“ HTMLHint validaÃ§Ã£o passou"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ O cÃ³digo do aluno Lucas Araujo foi auditado,"
          echo "estÃ¡ seguindo as normas corretas e estÃ¡ pronto"
          echo "para o deploy!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  lint-matrix:
    runs-on: ubuntu-latest
    name: Lint com Node.js ${{ matrix.node-version }}
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      
      - name: Exibir versÃ£o do Node.js
        run: |
          echo "ğŸ“¦ Node.js version:"
          node --version
          echo "npm version:"
          npm --version
      
      - name: ğŸ” Lint com Node.js ${{ matrix.node-version }}
        run: |
          echo "Executando linters com Node.js ${{ matrix.node-version }}..."
          
          # Validar HTML
          if find src -name "*.html" -type f | grep -q .; then
            echo "âœ… Arquivos HTML encontrados em src/"
          fi
          
          # Validar CSS  
          if find src/css -name "*.css" -type f | grep -q .; then
            echo "âœ… Arquivos CSS encontrados em src/css/"
          fi
          
          echo "âœ… Lint completado com sucesso em Node.js ${{ matrix.node-version }}"
      
      - name: ğŸ“Š Resumo do Lint  
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… LINT CONCLUÃDO COM SUCESSO!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Node.js version: ${{ matrix.node-version }}"
          echo "âœ“ HTML validado"
          echo "âœ“ CSS validado"  
          echo "âœ“ Estrutura organizada corretamente"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
